# FastMCPå°è£…RAGç³»ç»Ÿå®ç°æ–‡æ¡£

## ğŸ¯ æ¦‚è¿°

æœ¬é¡¹ç›®ä½¿ç”¨FastMCPæ¡†æ¶å°†RAGç³»ç»Ÿå°è£…ä¸ºæ ‡å‡†åŒ–çš„MCP (Model Context Protocol) æœåŠ¡å™¨ï¼Œå®ç°äº†é«˜åº¦æ¨¡å—åŒ–ã€å¯æ‰©å±•çš„æ™ºèƒ½æ–‡æ¡£å¤„ç†å’ŒçŸ¥è¯†æ£€ç´¢ç³»ç»Ÿã€‚

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### æ ¸å¿ƒç»„ä»¶

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    MCP Agent Layer                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   MCP Agent     â”‚  â”‚  ReAct Agent    â”‚  â”‚ Agent Core   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 MCP Client Layer                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚  â”‚ MCP Client Mgr  â”‚  â”‚ Local MCP Clientâ”‚                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                MCP Server Layer                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  RAG Server     â”‚  â”‚ Document Parser â”‚  â”‚ Table Extractâ”‚ â”‚
â”‚  â”‚                 â”‚  â”‚    Server       â”‚  â”‚   Server     â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Core Services                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   RAG Core      â”‚  â”‚   LLM Manager   â”‚  â”‚ Vector Store â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### MCPæœåŠ¡å™¨é›†ç¾¤

#### 1. RAGæœåŠ¡å™¨ (`rag-server`)
- **search_knowledge**: æ··åˆæ£€ç´¢å’Œæ™ºèƒ½é‡æ’åº
- **get_context**: è·å–æŸ¥è¯¢ç›¸å…³ä¸Šä¸‹æ–‡
- **analyze_query**: æŸ¥è¯¢æ„å›¾å’Œå¤æ‚åº¦åˆ†æ
- **get_retrieval_stats**: æ£€ç´¢ç³»ç»Ÿç»Ÿè®¡ä¿¡æ¯

#### 2. æ–‡æ¡£è§£ææœåŠ¡å™¨ (`document-parsing-server`)
- **parse_document**: Unstructuredé€šç”¨æ–‡æ¡£è§£æ
- **analyze_document_structure**: æ–‡æ¡£ç»“æ„åˆ†æ

#### 3. è¡¨æ ¼æå–æœåŠ¡å™¨ (`table-extraction-server`)
- **extract_tables_camelot**: Camelot PDFè¡¨æ ¼æå–
- **extract_tables_pdfplumber**: PDFPlumberè¡¨æ ¼æå–
- **compare_table_methods**: è¡¨æ ¼æå–æ–¹æ³•æ¯”è¾ƒ

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. å®‰è£…ä¾èµ–

```bash
pip install -r requirements.txt
```

### 2. åŸºç¡€ä½¿ç”¨

```python
from src.agent.core import AgentCore

# åˆ›å»ºå¯ç”¨MCPçš„Agent
agent = AgentCore(enable_mcp=True)
await agent.initialize()

# è·å–å¯ç”¨å·¥å…·
tools = await agent.get_mcp_tools()
print(f"å¯ç”¨å·¥å…·: {tools['count']} ä¸ª")

# æ™ºèƒ½æ–‡æ¡£è§£æ
result = await agent.parse_document_with_mcp("document.pdf")

# RAGé—®ç­”
answer = await agent.chat_with_mcp("ä»€ä¹ˆæ˜¯äººå·¥æ™ºèƒ½ï¼Ÿ", use_rag=True)
```

### 3. ç›´æ¥å·¥å…·è°ƒç”¨

```python
# è°ƒç”¨RAGæœç´¢
result = await agent.call_mcp_tool(
    "rag-server.search_knowledge",
    {
        "query": "æ·±åº¦å­¦ä¹ ",
        "top_k": 5,
        "retriever_type": "hybrid"
    }
)

# è°ƒç”¨æ–‡æ¡£è§£æ
result = await agent.call_mcp_tool(
    "document-parsing-server.parse_document",
    {
        "file_path": "document.pdf",
        "strategy": "auto"
    }
)
```

## ğŸ”§ MCPå·¥å…·è¯¦è§£

### RAGæœåŠ¡å™¨å·¥å…·

#### search_knowledge
```json
{
  "name": "search_knowledge",
  "description": "åœ¨çŸ¥è¯†åº“ä¸­æœç´¢ç›¸å…³ä¿¡æ¯ï¼Œæ”¯æŒæ··åˆæ£€ç´¢å’Œæ™ºèƒ½é‡æ’åº",
  "parameters": {
    "query": "æœç´¢æŸ¥è¯¢æ–‡æœ¬",
    "top_k": "è¿”å›ç»“æœæ•°é‡ (é»˜è®¤: 5)",
    "retriever_type": "æ£€ç´¢å™¨ç±»å‹ (vector|sparse|fulltext|hybrid)",
    "reranker_type": "é‡æ’åºå™¨ç±»å‹ (colbert|cross_encoder|mmr|ensemble)",
    "enable_multi_query": "æ˜¯å¦å¯ç”¨å¤šæŸ¥è¯¢æ£€ç´¢ (é»˜è®¤: true)"
  }
}
```

#### get_context
```json
{
  "name": "get_context", 
  "description": "è·å–æŸ¥è¯¢ç›¸å…³çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œç”¨äºLLMç”Ÿæˆ",
  "parameters": {
    "query": "æŸ¥è¯¢æ–‡æœ¬",
    "max_context_length": "æœ€å¤§ä¸Šä¸‹æ–‡é•¿åº¦ (é»˜è®¤: 4000)",
    "include_metadata": "æ˜¯å¦åŒ…å«å…ƒæ•°æ® (é»˜è®¤: true)"
  }
}
```

### æ–‡æ¡£è§£ææœåŠ¡å™¨å·¥å…·

#### parse_document
```json
{
  "name": "parse_document",
  "description": "ä½¿ç”¨Unstructuredåº“è§£æå„ç§æ ¼å¼çš„æ–‡æ¡£",
  "parameters": {
    "file_path": "æ–‡ä»¶è·¯å¾„",
    "strategy": "è§£æç­–ç•¥ (auto|fast|accurate|balanced)",
    "extract_images": "æ˜¯å¦æå–å›¾åƒ (é»˜è®¤: true)",
    "chunking_strategy": "åˆ†å—ç­–ç•¥ (by_title|by_page|basic)"
  }
}
```

### è¡¨æ ¼æå–æœåŠ¡å™¨å·¥å…·

#### extract_tables_camelot
```json
{
  "name": "extract_tables_camelot",
  "description": "ä½¿ç”¨Camelotæå–PDFè¡¨æ ¼ï¼Œé€‚åˆç»“æ„åŒ–è¡¨æ ¼",
  "parameters": {
    "file_path": "PDFæ–‡ä»¶è·¯å¾„",
    "pages": "é¡µé¢èŒƒå›´ (å¦‚'1-3'æˆ–'all')",
    "flavor": "æ£€æµ‹ç®—æ³• (lattice|stream)",
    "table_areas": "è¡¨æ ¼åŒºåŸŸåæ ‡ (å¯é€‰)"
  }
}
```

## ğŸ¤– Agentå·¥ä½œæµç¨‹

### æ™ºèƒ½æ–‡æ¡£è§£ææµç¨‹

```python
# Agentæ¨ç†è¿‡ç¨‹ç¤ºä¾‹
"""
Thought: ç”¨æˆ·è¦æ±‚è§£æPDFæ–‡æ¡£ï¼Œæˆ‘éœ€è¦å…ˆè·å–æ–‡æ¡£åŸºæœ¬ä¿¡æ¯

Action: document-parsing-server.parse_document
Action Input: {"file_path": "document.pdf", "strategy": "auto"}

Observation: è§£ææˆåŠŸï¼Œå‘ç°æ–‡æ¡£åŒ…å«è¡¨æ ¼å’Œå›¾åƒ

Thought: æ£€æµ‹åˆ°è¡¨æ ¼å†…å®¹ï¼Œéœ€è¦ä½¿ç”¨ä¸“ä¸šè¡¨æ ¼æå–å·¥å…·

Action: table-extraction-server.extract_tables_camelot  
Action Input: {"file_path": "document.pdf", "flavor": "lattice"}

Observation: æˆåŠŸæå–3ä¸ªè¡¨æ ¼ï¼Œå¹³å‡å‡†ç¡®ç‡0.92

Thought: è¡¨æ ¼æå–è´¨é‡è‰¯å¥½ï¼Œç°åœ¨æ•´åˆæ‰€æœ‰ç»“æœ

Final Answer: æ–‡æ¡£è§£æå®Œæˆï¼ŒåŒ…å«æ–‡æœ¬ã€3ä¸ªé«˜è´¨é‡è¡¨æ ¼...
"""
```

## ğŸ“Š æ€§èƒ½ç‰¹æ€§

### å¹¶å‘å¤„ç†
- **å¼‚æ­¥æ¶æ„**: æ‰€æœ‰MCPæœåŠ¡å™¨æ”¯æŒå¼‚æ­¥è°ƒç”¨
- **å¹¶è¡Œå·¥å…·è°ƒç”¨**: æ”¯æŒæ‰¹é‡å·¥å…·è°ƒç”¨
- **è´Ÿè½½å‡è¡¡**: æ”¯æŒå¤šå®ä¾‹MCPæœåŠ¡å™¨éƒ¨ç½²

### å®¹é”™æœºåˆ¶
- **å¥åº·æ£€æŸ¥**: å®æ—¶ç›‘æ§æœåŠ¡å™¨çŠ¶æ€
- **è‡ªåŠ¨é‡è¯•**: å·¥å…·è°ƒç”¨å¤±è´¥è‡ªåŠ¨é‡è¯•
- **é™çº§ç­–ç•¥**: æœåŠ¡ä¸å¯ç”¨æ—¶çš„å¤‡é€‰æ–¹æ¡ˆ

### ç›‘æ§æŒ‡æ ‡
```python
# è·å–ç³»ç»ŸçŠ¶æ€
server_status = await agent.get_mcp_server_status()
client_stats = agent.mcp_client_manager.get_client_statistics()

print(f"æœåŠ¡å™¨çŠ¶æ€: {server_status['status']}")
print(f"æ€»è°ƒç”¨æ¬¡æ•°: {client_stats['total_calls']}")
print(f"æˆåŠŸç‡: {client_stats['success_rate']:.2%}")
```

## ğŸ”Œ æ‰©å±•å¼€å‘

### æ·»åŠ æ–°çš„MCPæœåŠ¡å™¨

```python
from src.mcp.types.base import MCPServer, MCPTool

class CustomMCPServer(MCPServer):
    def __init__(self):
        super().__init__(name="custom-server", version="1.0.0")
        self._register_tools()
    
    def _register_tools(self):
        self.register_tool(CustomTool())

class CustomTool(MCPTool):
    def __init__(self):
        super().__init__(
            name="custom_tool",
            description="è‡ªå®šä¹‰å·¥å…·æè¿°"
        )
    
    async def execute(self, **kwargs):
        # å·¥å…·å®ç°é€»è¾‘
        return {"success": True, "result": "å¤„ç†ç»“æœ"}
```

### æ³¨å†Œåˆ°æœåŠ¡å™¨ç®¡ç†å™¨

```python
# åœ¨server_manager.pyä¸­æ·»åŠ 
custom_server = CustomMCPServer()
await self.register_server(custom_server)
await self.start_server("custom-server")
```

## ğŸ§ª æµ‹è¯•å’ŒéªŒè¯

### è¿è¡Œæµ‹è¯•

```bash
# åŸºç¡€åŠŸèƒ½æµ‹è¯•
python test_mcp_implementation.py

# ä½¿ç”¨ç¤ºä¾‹æ¼”ç¤º
python examples/mcp_usage_example.py
```

### æµ‹è¯•è¦†ç›–

- âœ… MCPæœåŠ¡å™¨å¯åŠ¨å’Œåœæ­¢
- âœ… å·¥å…·æ³¨å†Œå’Œå‘ç°
- âœ… å®¢æˆ·ç«¯è¿æ¥å’Œè°ƒç”¨
- âœ… Agentæ¨ç†å’Œå·¥å…·ä½¿ç”¨
- âœ… é”™è¯¯å¤„ç†å’Œæ¢å¤
- âœ… æ€§èƒ½ç›‘æ§å’Œç»Ÿè®¡

## ğŸš€ éƒ¨ç½²æ–¹æ¡ˆ

### Dockeréƒ¨ç½²

```yaml
# docker-compose.mcp.yml
version: '3.8'
services:
  rag-mcp-server:
    build: ./src/mcp/servers/rag_server
    ports: ["9001:9001"]
    
  document-parsing-server:
    build: ./src/mcp/servers/document_parsing_server  
    ports: ["9002:9002"]
    
  table-extraction-server:
    build: ./src/mcp/servers/table_extraction_server
    ports: ["9003:9003"]
    
  epkbs-app:
    build: .
    ports: ["8000:8000"]
    environment:
      - MCP_SERVERS=rag-mcp-server:9001,document-parsing-server:9002
    depends_on:
      - rag-mcp-server
      - document-parsing-server
```

### ç”Ÿäº§ç¯å¢ƒé…ç½®

```python
# config/mcp_settings.py
MCP_CONFIG = {
    "servers": {
        "rag-server": {
            "host": "localhost",
            "port": 9001,
            "max_connections": 100
        },
        "document-parsing-server": {
            "host": "localhost", 
            "port": 9002,
            "max_connections": 50
        }
    },
    "client": {
        "timeout": 30,
        "retry_attempts": 3,
        "batch_size": 10
    }
}
```

## ğŸ“ˆ ä¼˜åŠ¿æ€»ç»“

### ğŸ¯ æ ‡å‡†åŒ–
- **MCPåè®®**: ç¬¦åˆå·¥ä¸šæ ‡å‡†çš„å·¥å…·è°ƒç”¨åè®®
- **ç»Ÿä¸€æ¥å£**: æ‰€æœ‰å·¥å…·éƒ½æœ‰ä¸€è‡´çš„è°ƒç”¨æ–¹å¼
- **Schemaé©±åŠ¨**: å®Œæ•´çš„å‚æ•°éªŒè¯å’Œæ–‡æ¡£

### ğŸ”§ æ¨¡å—åŒ–
- **æœåŠ¡åˆ†ç¦»**: æ¯ä¸ªåŠŸèƒ½éƒ½æ˜¯ç‹¬ç«‹çš„MCPæœåŠ¡å™¨
- **æ¾è€¦åˆ**: æœåŠ¡å™¨ä¹‹é—´æ— ç›´æ¥ä¾èµ–
- **å¯æ›¿æ¢**: å¯ä»¥è½»æ¾æ›¿æ¢æˆ–å‡çº§å•ä¸ªæœåŠ¡

### ğŸš€ å¯æ‰©å±•
- **æ°´å¹³æ‰©å±•**: æ”¯æŒå¤šå®ä¾‹éƒ¨ç½²
- **æ’ä»¶åŒ–**: æ–°åŠŸèƒ½åªéœ€å®ç°MCPæœåŠ¡å™¨
- **è¯­è¨€æ— å…³**: MCPæœåŠ¡å™¨å¯ç”¨ä»»ä½•è¯­è¨€å®ç°

### ğŸ¤– æ™ºèƒ½åŒ–
- **Agenté©±åŠ¨**: æ™ºèƒ½é€‰æ‹©å’Œç»„åˆå·¥å…·
- **è‡ªé€‚åº”**: æ ¹æ®ä»»åŠ¡å¤æ‚åº¦è°ƒæ•´ç­–ç•¥
- **å­¦ä¹ èƒ½åŠ›**: å¯ä»¥å­¦ä¹ æœ€ä½³å·¥å…·ä½¿ç”¨æ¨¡å¼

è¿™ä¸ªFastMCPå°è£…æ–¹æ¡ˆå°†RAGç³»ç»Ÿè½¬å˜ä¸ºä¸€ä¸ªé«˜åº¦æ™ºèƒ½ã€å¯æ‰©å±•çš„ä¼ä¸šçº§æ–‡æ¡£å¤„ç†å¹³å°ï¼
